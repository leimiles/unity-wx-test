name: Nightly Code Review - Assets/Runtime

on:
  schedule:
    # åŒ—äº¬æ—¶é—´å‡Œæ™¨ 2:00 = UTC 18:00 (å‰ä¸€å¤©)
    - cron: '0 18 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨æµ‹è¯•

jobs:
  review-runtime-changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read

    steps:
      - name:  Checkout develop branch
        uses: actions/checkout@v4
        with:
          ref:  develop
          fetch-depth: 0

      - name: Get today's changes in Assets/Runtime
        id: get_changes
        run:  |
          echo "ğŸ” Analyzing changes in Assets/Runtime on develop branch..."

          # è·å–è¿‡å» 24 å°æ—¶çš„å˜æ›´
          CHANGED_FILES=$(git log develop \
            --since="24 hours ago" \
            --name-only \
            --pretty=format: \
            -- "Assets/Runtime/" \
            | sort | uniq | grep "\.cs$" || echo "")

          echo "$CHANGED_FILES" > /tmp/changed_files.txt
          # è®¡ç®—æ–‡ä»¶æ•°é‡ï¼Œä½¿ç”¨ wc -l æ›´å¯é 
          if [ -z "$CHANGED_FILES" ]; then
            FILE_COUNT=0
          else
            # ä½¿ç”¨ wc -l è®¡ç®—è¡Œæ•°ï¼ˆæ¯ä¸ªæ–‡ä»¶ä¸€è¡Œï¼‰ï¼Œæ›´å¯é 
            FILE_COUNT=$(echo "$CHANGED_FILES" | grep "\.cs$" | wc -l | tr -d '[:space:]')
          fi
          # ç¡®ä¿ FILE_COUNT æ˜¯çº¯æ•°å­—ï¼Œå¦‚æœä¸ºç©ºåˆ™è®¾ç½®ä¸º 0
          FILE_COUNT=${FILE_COUNT:-0}

          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT

          # è·å–æäº¤ä¿¡æ¯
          COMMITS=$(git log develop \
            --since="24 hours ago" \
            --pretty=format:"- %h:  %s (by %an, %ar)" \
            -- "Assets/Runtime/")

          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # ç”Ÿæˆæ–‡ä»¶å˜æ›´è¯¦æƒ…
          echo "## Changed Files in Assets/Runtime" > /tmp/file_changes.md
          echo "" >> /tmp/file_changes.md

          if [ "$FILE_COUNT" -gt "0" ]; then
            echo "Found $FILE_COUNT changed C# files:" >> /tmp/file_changes.md
            echo "" >> /tmp/file_changes.md
            echo "\`\`\`" >> /tmp/file_changes.md
            echo "$CHANGED_FILES" >> /tmp/file_changes.md
            echo "\`\`\`" >> /tmp/file_changes.md
          else
            echo "No C# files changed in the last 24 hours." >> /tmp/file_changes.md
          fi

      - name: Extract code snippets from changed files
        id: extract_code
        if: steps.get_changes.outputs.file_count != '0'
        run: |
          echo "ğŸ“„ Extracting code snippets..."

          echo "## Code Changes Details" > /tmp/code_snippets.md
          echo "" >> /tmp/code_snippets.md

          # å¯¹æ¯ä¸ªå˜æ›´çš„æ–‡ä»¶ï¼Œè·å–æœ€è¿‘çš„ diff
          while IFS= read -r file; do
            if [ -z "$file" ]; then
              continue
            fi

            echo "### ğŸ“ \`$file\`" >> /tmp/code_snippets.md
            echo "" >> /tmp/code_snippets.md

            # è·å–æœ€è¿‘ä¸€æ¬¡ä¿®æ”¹æ­¤æ–‡ä»¶çš„ commit
            LAST_COMMIT=$(git log -1 --since="24 hours ago" --pretty=format:"%h" -- "$file")

            if [ -n "$LAST_COMMIT" ]; then
              COMMIT_MSG=$(git log -1 --pretty=format:"%s" "$LAST_COMMIT")
              COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an" "$LAST_COMMIT")

              echo "**Commit:** \`$LAST_COMMIT\` - $COMMIT_MSG (by $COMMIT_AUTHOR)" >> /tmp/code_snippets.md
              echo "" >> /tmp/code_snippets.md
              echo "<details>" >> /tmp/code_snippets.md
              echo "<summary>View Diff</summary>" >> /tmp/code_snippets.md
              echo "" >> /tmp/code_snippets.md
              echo "\`\`\`diff" >> /tmp/code_snippets.md
              git show "$LAST_COMMIT" -- "$file" | tail -n +5 | head -n 150 >> /tmp/code_snippets.md
              echo "\`\`\`" >> /tmp/code_snippets.md
              echo "</details>" >> /tmp/code_snippets.md
              echo "" >> /tmp/code_snippets.md
            fi
          done < /tmp/changed_files.txt

      - name: Generate statistics
        id: stats
        run: |
          echo "ğŸ“Š Generating code statistics..."

          echo "## Assets/Runtime Statistics" > /tmp/stats.md
          echo "" >> /tmp/stats.md

          # ç»Ÿè®¡æ€»çš„ C# æ–‡ä»¶æ•°
          TOTAL_CS_FILES=$(find Assets/Runtime -name "*.cs" 2>/dev/null | wc -l)
          echo "- Total C# files in Assets/Runtime: **$TOTAL_CS_FILES**" >> /tmp/stats.md

          # ç»Ÿè®¡æ€»è¡Œæ•°
          TOTAL_LINES=$(find Assets/Runtime -name "*.cs" -exec cat {} \; 2>/dev/null | wc -l)
          echo "- Total lines of code:  **$TOTAL_LINES**" >> /tmp/stats.md
          echo "" >> /tmp/stats.md

          # æŒ‰æ¨¡å—ç»Ÿè®¡ï¼ˆåªæ˜¾ç¤ºæœ‰å˜æ›´çš„æ¨¡å—ï¼‰
          if [ -s /tmp/changed_files.txt ]; then
            echo "### Changed Modules" >> /tmp/stats.md
            echo "" >> /tmp/stats.md

            # æå–æ¨¡å—å
            MODULES=$(cat /tmp/changed_files.txt | sed 's|Assets/Runtime/||' | cut -d'/' -f1 | sort | uniq)

            for module in $MODULES; do
              if [ -d "Assets/Runtime/$module" ]; then
                file_count=$(find "Assets/Runtime/$module" -name "*.cs" 2>/dev/null | wc -l)
                line_count=$(find "Assets/Runtime/$module" -name "*.cs" -exec cat {} \; 2>/dev/null | wc -l)
                echo "- **$module**: $file_count files, $line_count lines" >> /tmp/stats.md
              fi
            done
          fi

      - name: Create review issue with Copilot mention
        if: steps.get_changes.outputs.file_count != '0'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TODAY=$(date -u +%Y-%m-%d)
          BEIJING_DATE=$(TZ='Asia/Shanghai' date +%Y-%m-%d)

          # æ„å»º Issue å†…å®¹
          cat << 'EOF' > /tmp/issue_body.md
          # ğŸ¤– Nightly Code Review - Assets/Runtime

          **Review Date:** BEIJING_DATE_PLACEHOLDER (Beijing Time)
          **Branch:** `develop`
          **Scope:** `Assets/Runtime/`
          **Analysis Time:** 02:00 Beijing Time

          ---

          EOF

          # æ·»åŠ æäº¤ä¿¡æ¯
          echo "## ğŸ“ Commits in Last 24 Hours" >> /tmp/issue_body.md
          echo "" >> /tmp/issue_body.md
          if [ -n "${{ steps.get_changes.outputs.commits }}" ]; then
            echo "${{ steps.get_changes.outputs.commits }}" >> /tmp/issue_body.md
          else
            echo "No commits found" >> /tmp/issue_body.md
          fi
          echo "" >> /tmp/issue_body.md
          echo "---" >> /tmp/issue_body.md
          echo "" >> /tmp/issue_body.md

          # æ·»åŠ æ–‡ä»¶å˜æ›´
          cat /tmp/file_changes.md >> /tmp/issue_body.md
          echo "" >> /tmp/issue_body.md
          echo "---" >> /tmp/issue_body.md
          echo "" >> /tmp/issue_body.md

          # æ·»åŠ ä»£ç ç‰‡æ®µ
          if [ -f /tmp/code_snippets.md ]; then
            cat /tmp/code_snippets.md >> /tmp/issue_body.md
            echo "" >> /tmp/issue_body.md
            echo "---" >> /tmp/issue_body.md
            echo "" >> /tmp/issue_body.md
          fi

          # æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
          cat /tmp/stats.md >> /tmp/issue_body.md
          echo "" >> /tmp/issue_body.md
          echo "---" >> /tmp/issue_body.md
          echo "" >> /tmp/issue_body.md

          # Copilot å®¡æŸ¥è¯·æ±‚
          cat << 'COPILOT_EOF' >> /tmp/issue_body.md
          ## ğŸ” Copilot Review Request

          @copilot è¯·å¸®æˆ‘å®¡æŸ¥ä¸Šè¿° Assets/Runtime ç›®å½•ä¸‹ä»Šå¤©çš„ä»£ç å˜æ›´ï¼Œé‡ç‚¹å…³æ³¨ï¼š

          ### å®¡æŸ¥ç»´åº¦

          1. **ä»£ç è´¨é‡**
             - æ˜¯å¦éµå¾ª C# å’Œ Unity æœ€ä½³å®è·µï¼Ÿ
             - å‘½åè§„èŒƒæ˜¯å¦ç»Ÿä¸€ï¼Ÿ
             - ä»£ç ç»“æ„æ˜¯å¦æ¸…æ™°ï¼Ÿ

          2. **æ½œåœ¨ Bug**
             - æ˜¯å¦å­˜åœ¨é€»è¾‘é”™è¯¯ï¼Ÿ
             - æ˜¯å¦æœ‰ç©ºå¼•ç”¨é£é™©ï¼Ÿ
             - æ˜¯å¦å­˜åœ¨å†…å­˜æ³„æ¼å¯èƒ½ï¼Ÿ
             - Unity ç”Ÿå‘½å‘¨æœŸä½¿ç”¨æ˜¯å¦æ­£ç¡®ï¼Ÿ

          3. **æ€§èƒ½é—®é¢˜**
             - Update/FixedUpdate ä¸­æ˜¯å¦æœ‰é‡å¤è®¡ç®—ï¼Ÿ
             - æ˜¯å¦å­˜åœ¨ä¸å¿…è¦çš„ GC åˆ†é…ï¼Ÿ
             - æ˜¯å¦æœ‰é¢‘ç¹çš„ GetComponent è°ƒç”¨ï¼Ÿ
             - å­—ç¬¦ä¸²æ‹¼æ¥æ˜¯å¦ä¼˜åŒ–ï¼Ÿ

          4. **æ¶æ„è®¾è®¡**
             - æ¨¡å—ä¹‹é—´çš„è€¦åˆåº¦æ˜¯å¦åˆç†ï¼Ÿ
             - å•ä¸€èŒè´£åŸåˆ™æ˜¯å¦éµå®ˆï¼Ÿ
             - ä¾èµ–å…³ç³»æ˜¯å¦æ¸…æ™°ï¼Ÿ

          5. **å®‰å…¨æ€§**
             - æ˜¯å¦å­˜åœ¨å®‰å…¨æ¼æ´ï¼Ÿ
             - è¾“å…¥éªŒè¯æ˜¯å¦å……åˆ†ï¼Ÿ

          6. **å¯ç»´æŠ¤æ€§**
             - ä»£ç æ˜¯å¦æ˜“äºç†è§£ï¼Ÿ
             - æ˜¯å¦æœ‰å……åˆ†çš„æ³¨é‡Šï¼Ÿ
             - æ˜¯å¦ä¾¿äºåç»­æ‰©å±•ï¼Ÿ

          ### è¾“å‡ºæ ¼å¼

          è¯·é’ˆå¯¹æ¯ä¸ªå˜æ›´çš„æ–‡ä»¶æä¾›ï¼š
          - âœ… åšå¾—å¥½çš„åœ°æ–¹
          - âš ï¸ éœ€è¦æ³¨æ„çš„é—®é¢˜
          - ğŸ’¡ å…·ä½“çš„æ”¹è¿›å»ºè®®ï¼ˆé™„ä»£ç ç¤ºä¾‹ï¼‰
          - ğŸ¯ ä¼˜å…ˆçº§è¯„ä¼°ï¼ˆé«˜/ä¸­/ä½ï¼‰

          ---

          *ğŸ“§ æœ¬æ¬¡å®¡æŸ¥ç»“æœçš„æ‘˜è¦å°†åœ¨æ—©ä¸Š 10:00 é€šè¿‡é‚®ä»¶å‘é€*
          COPILOT_EOF

          # æ›¿æ¢æ—¥æœŸå˜é‡
          sed -i "s/BEIJING_DATE_PLACEHOLDER/$BEIJING_DATE/g" /tmp/issue_body.md

          # åˆ›å»º Issue
          gh issue create \
            --title "ğŸ” Nightly Review:  Assets/Runtime - $BEIJING_DATE" \
            --body-file /tmp/issue_body.md \
            --label "code-review,automated,runtime,nightly" \
            --assignee leimiles

      - name: Create no-changes summary
        if: steps.get_changes.outputs.file_count == '0'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BEIJING_DATE=$(TZ='Asia/Shanghai' date +%Y-%m-%d)

          cat << EOF > /tmp/no_changes.md
          # âœ… Nightly Review Summary - Assets/Runtime

          **Review Date:** $BEIJING_DATE (Beijing Time)
          **Branch:** \`develop\`
          **Scope:** \`Assets/Runtime/\`

          ---

          ## No Changes Detected

          No C# files were modified in Assets/Runtime/ directory in the last 24 hours.

          ---

          EOF

          cat /tmp/stats.md >> /tmp/no_changes.md

          gh issue create \
            --title "âœ… Nightly Summary: Assets/Runtime - $BEIJING_DATE (No Changes)" \
            --body-file /tmp/no_changes.md \
            --label "code-review,automated,runtime,no-changes"

      - name: Save review data for morning email
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-review-data
          path: |
            /tmp/file_changes.md
            /tmp/code_snippets.md
            /tmp/stats.md
          retention-days: 1
